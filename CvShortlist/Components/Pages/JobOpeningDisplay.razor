@page "/JobOpeningDisplay/{JobOpeningId:guid?}"
@rendermode InteractiveServer

@using CvShortlist.POCOs

<PageTitle>Job Opening Display - CV Shortlist</PageTitle>

<h3>Job Opening Display</h3>

@if (CanShowJobOpening)
{
    <div class="d-flex justify-content-between mb-3">
        <a href="@Paths.JobOpenings" class="btn btn-outline-secondary">Back to Job Openings</a>
        @if (CanDeleteJobOpening)
        {
            <button type="button" class="btn btn-danger" @onclick="DeleteJobOpening">Delete job opening</button>
        }
    </div>
}

<section id="JobDataLoading">
    @if (_hasError)
    {
        <div class="alert alert-danger">Error loading job opening. Please refresh the page.</div>
    }
    else if (_isLoading)
    {
        <div class="alert alert-info">Loading job opening...</div>
    }
    else if (_isPreparingPdfFilesForUpload)
    {
        <div class="alert alert-info">
            <p>Preparing your selected PDF files for upload...</p>
            <p>Please do not leave this page.</p>
        </div>
    }
    else if (_isUploadingPdfFiles)
    {
        <div class="alert alert-info">
            <p>Uploading your selected PDF files...</p>
            <p>Please do not leave this page.</p>

            @if (_pdfUploadMessages.Any())
            {
                <ul>
                    @foreach (var aPdfUploadMessage in _pdfUploadMessages)
                    {
                        <li>@aPdfUploadMessage.Message</li>
                    }
                </ul>
            }
        </div>
    }
    else if (_isDeletingCandidateCvs)
    {
        <div class="alert alert-info">
            <p>Deleting your selected candidate CVs...</p>
            <p>Please do not leave this page.</p>
        </div>
    }
    else if (_isDeletingJobOpening)
    {
        <div class="alert alert-info">
            <p>Deleting the job opening...</p>
            <p>Please do not leave this page.</p>
        </div>
    }
    else if (ShouldShowInAnalysisMessage)
    {
        <div class="alert alert-info">
            <p>Analyzing the uploaded candidate CVs...</p>
            <p>
                You can leave this page, and check for the analysis results in about
                @_jobOpeningViewModel.JobOpeningAnalysisTimeInMinutes
                @(_jobOpeningViewModel.JobOpeningAnalysisTimeInMinutes == 1 ? "minute" : "minutes").
            </p>
        </div>
    }
    else if (_jobOpening is null)
    {
        <div class="alert alert-danger">The job opening does not exist.</div>
    }
</section>

@if (CanShowOpenJobLogic)
{
    <EditForm Model="_jobOpeningViewModel" OnValidSubmit="HandleJobFormDataSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">Job opening details</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Name:</label>
                            <InputText @bind-Value="_jobOpeningViewModel.Name" class="form-control" />
                            <ValidationMessage For="() => _jobOpeningViewModel.Name" class="text-danger" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description:</label>
                            <textarea @bind="_jobOpeningViewModel.Description"
                                      @bind:event="oninput"
                                      class="form-control @context.FieldCssClass(() => _jobOpeningViewModel.Description)"
                                      rows="10"></textarea>
                            <ValidationMessage For="() => _jobOpeningViewModel.Description" class="text-danger" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Analysis language:</label>
                            <InputSelect @bind-Value="_jobOpeningViewModel.AnalysisLanguage" class="form-select">
                                @foreach (var anAvailableLanguage in _jobOpeningViewModel.AvailableLanguages)
                                {
                                    <option value="@anAvailableLanguage">@anAvailableLanguage</option>
                                }
                            </InputSelect>
                        </div>

                        <dl class="row">
                            <dt class="col-sm-3">Status:</dt>
                            <dd class="col-sm-9">@_jobOpeningViewModel.Status</dd>

                            <dt class="col-sm-3">Date created:</dt>
                            <dd class="col-sm-9">@_jobOpeningViewModel.DateCreated</dd>

                            <dt class="col-sm-3">Date last modified:</dt>
                            <dd class="col-sm-9">@_jobOpeningViewModel.DateLastModified</dd>

                            <dt class="col-sm-3">Date of expiration:</dt>
                            <dd class="col-sm-9">@_jobOpeningViewModel.DateOfExpiration</dd>
                        </dl>

                        <button type="submit" class="btn btn-primary" @onclick="() => _jobOpeningViewModel.SubmitActionType = JobOpeningSubmitActionType.UpdateProperties">
                            Update job
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">Upload and analyze candidate CVs</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="pdfFilesInput"
                                   class="btn-primary form-control"
                                   style="cursor: pointer;">
                                Select PDF files and ZIP archives
                            </label>
                            <input id="pdfFilesInput"
                                   type="file"
                                   multiple
                                   accept="application/pdf, application/zip"
                                   style="display:none;"
                                   @onchange="StoreSelectedPdfFilesInBrowser" />
                            <span id="pdfFilesInputInfo" class="form-text" style="font-size: 1.03em;">
                                No files selected
                            </span>
                        </div>

                        <p class="form-text" style="font-size: 1.03em;">
                            Maximum @MaximumFileUploadsAtOnce files allowed to be uploaded at once.
                        </p>
                        <p class="form-text" style="font-size: 1.03em;">
                            @_jobOpeningViewModel.RemainingCandidateCvsAllowedToBeUploaded remaining PDF files allowed
                            to be uploaded.
                        </p>

                        @{ var warningAndErrorPdfUploadMessages = WarningAndErrorPdfUploadMessages; }
                        @if (warningAndErrorPdfUploadMessages.Any())
                        {
                            <div class="alert alert-warning">
                                <ul>
                                    @foreach (var aWarningAndErrorPdfUploadMessage in warningAndErrorPdfUploadMessages)
                                    {
                                        <li>@aWarningAndErrorPdfUploadMessage.Message</li>
                                    }
                                </ul>
                            </div>
                        }

                        <div class="d-grid gap-3">
                            <button type="button"
                                    class="btn btn-success"
                                    disabled="@(!ShouldAllowUploadPdfFiles)"
                                    @onclick="UploadPdfFiles">
                                Upload PDF files and ZIP archives
                            </button>
                            <button type="submit"
                                    class="btn btn-info"
                                    disabled="@(!ShouldAllowCandidateCvsAnalysis)"
                                    @onclick="() => _jobOpeningViewModel.SubmitActionType = JobOpeningSubmitActionType.AnalyzeUploadedCvs">
                                Analyze uploaded candidate CVs
                            </button>
                        </div>
                    </div>
                </div>

                @if (_jobOpeningViewModel.CandidateCvViewModels.Any())
                {
                    <div class="card mb-6">
                        <div class="card-header">Uploaded candidate CVs</div>
                        <div class="card-body">
                            <Pagination CurrentPage="@_jobOpeningViewModel.CurrentPage"
                                        TotalPages="@_jobOpeningViewModel.TotalPages"
                                        OnPageChanged="ChangePage" />

                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Actions</th>
                                        <th>File name</th>
                                        <th>Date</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var aCandidateCvViewModel in _jobOpeningViewModel.CandidateCvViewModels)
                                    {
                                        <tr>
                                            <td class="align-middle">
                                                <InputCheckbox @bind-Value="@aCandidateCvViewModel.IsSelected"/>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-xs btn-outline-primary" @onclick="async () => await OpenCandidateCv(aCandidateCvViewModel)">Open</button>
                                                    <button type="button" class="btn btn-xs btn-outline-primary" @onclick="async () => await DownloadCandidateCv(aCandidateCvViewModel)">Download</button>
                                                </div>
                                            </td>
                                            <td>@aCandidateCvViewModel.FileName</td>
                                            <td>@aCandidateCvViewModel.DateCreated</td>
                                        </tr>
                                    }
                                    </tbody>
                                </table>
                            </div>

                            <Pagination CurrentPage="@_jobOpeningViewModel.CurrentPage"
                                        TotalPages="@_jobOpeningViewModel.TotalPages"
                                        OnPageChanged="ChangePage" />

                            <div class="mt-2">
                                <button type="button"
                                        class="btn btn-sm btn-danger"
                                        @onclick="DeleteSelectedCandidateCvs">
                                    Delete selected
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </EditForm>
}
else if (CanShowAnalyzedJobLogic)
{
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Job opening details</div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-2">Name:</dt>
                        <dd class="col-sm-10">@_jobOpeningViewModel.Name</dd>

                        <dt class="col-sm-2">Description:</dt>
                        <dd class="col-sm-10">
                            <textarea class="form-control" readonly rows="10">@_jobOpeningViewModel.Description</textarea>
                        </dd>

                        <dt class="col-sm-2">Analysis language:</dt>
                        <dd class="col-sm-10">@_jobOpeningViewModel.AnalysisLanguage</dd>

                        <dt class="col-sm-2">Status:</dt>
                        <dd class="col-sm-10">@_jobOpeningViewModel.Status</dd>

                        <dt class="col-sm-2">Date created:</dt>
                        <dd class="col-sm-10">@_jobOpeningViewModel.DateCreated</dd>

                        <dt class="col-sm-2">Date last modified:</dt>
                        <dd class="col-sm-10">@_jobOpeningViewModel.DateLastModified</dd>

                        <dt class="col-sm-2">Date of expiration:</dt>
                        <dd class="col-sm-10">@_jobOpeningViewModel.DateOfExpiration</dd>
                    </dl>
                </div>
            </div>

            @if (_jobOpeningViewModel.CandidateCvViewModels.Any())
            {
                <div class="card mb-5">
                    <div class="card-header">Analyzed candidate CVs</div>
                    <div class="card-body">
                        <Pagination CurrentPage="@_jobOpeningViewModel.CurrentPage"
                                    TotalPages="@_jobOpeningViewModel.TotalPages"
                                    OnPageChanged="ChangePage" />

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                <tr>
                                    <th>Open</th>
                                    <th>Download</th>
                                    <th>File name</th>
                                    <th>Date</th>
                                    <th>Rating</th>
                                    <th>CV Summary</th>
                                    <th>Advantages</th>
                                    <th>Disadvantages</th>
                                    <th>Reasons for rating</th>
                                </tr>
                                </thead>
                                <tbody>
                                    @foreach (var aCandidateCvViewModel in _jobOpeningViewModel.CandidateCvViewModels)
                                    {
                                        <tr>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary"
                                                        @onclick="async () => await OpenCandidateCv(aCandidateCvViewModel)">
                                                    Open
                                                </button>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary"
                                                        @onclick="async () => await DownloadCandidateCv(aCandidateCvViewModel)">
                                                    Download
                                                </button>
                                            </td>
                                            <td>@aCandidateCvViewModel.FileName</td>
                                            <td>@aCandidateCvViewModel.DateCreated</td>
                                            <td>@aCandidateCvViewModel.Analysis!.Rating</td>
                                            <td><pre style="white-space: pre-wrap;">@aCandidateCvViewModel.Analysis!.CvSummary</pre></td>
                                            <td><pre style="white-space: pre-wrap;">@aCandidateCvViewModel.Analysis!.Advantages</pre></td>
                                            <td><pre style="white-space: pre-wrap;">@aCandidateCvViewModel.Analysis!.Disadvantages</pre></td>
                                            <td><pre style="white-space: pre-wrap;">@aCandidateCvViewModel.Analysis!.ReasonsForRating</pre></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <Pagination CurrentPage="@_jobOpeningViewModel.CurrentPage"
                                    TotalPages="@_jobOpeningViewModel.TotalPages"
                                    OnPageChanged="ChangePage" />
                    </div>
                </div>
            }
        </div>
    </div>
}
